// Generated by CoffeeScript 2.6.1
var DivList;

import PreDiv from "./gameEditor_preDiv";

import gEData from "./gameEditor_data";

import Notice from "../common/notice";

import {
  v4 as uuid
} from "uuid";

export default DivList = class {
  constructor(obj = {
      data: [],
      historyDatas: [],
      cursor: -1,
      groups: [],
      groupLevel: 0,
      copy: [],
      group: [],
      presentGroup: "",
      showZIndex: false,
      showZIndexTimer: null
    }) {
    var i, key, len, ref, value;
    ref = Object.entries(obj);
    for (i = 0, len = ref.length; i < len; i++) {
      [key, value] = ref[i];
      this[key] = value;
    }
  }

  findById(id) {
    checkType(arguments, ["string"], "gameEditor.DivList.findById()");
    return this.data.find((preDiv) => {
      return preDiv.id === id;
    });
  }

  add(preDiv, noRecord) {
    if (!(preDiv instanceof PreDiv)) {
      throw new Error("添加的元素不是PreDiv的实例");
    }
    preDiv.divList = this;
    preDiv.zIndex = 1;
    if (this.presentGroup) {
      preDiv.linkid = this.presentGroup;
    }
    this.data.push(preDiv);
    if (!noRecord) { //不要记录
      return this.record();
    }
  }

  record() {
    var copyData, idMap;
    if (this.historyDatas.length !== this.cursor + 1) {
      this.historyDatas.length = this.cursor + 1;
    }
    copyData = this.data.map((preDiv) => {
      return new PreDiv({...preDiv});
    });
    
    //id映射
    idMap = {};
    this.data.forEach((preDiv, index) => {
      return idMap[preDiv.id] = copyData[index].id;
    });
    //根据映射表修改linkid
    copyData.forEach((preDiv, index) => {
      return preDiv.linkid = idMap[preDiv.linkid] || "";
    });
    copyData.presentGroup = this.presentGroup;
    this.historyDatas.push(copyData);
    return this.cursor++;
  }

  undo() {
    if (this.cursor - 1 > -1) {
      this.cursor--;
      this.data = [...this.historyDatas[this.cursor]];
      return this.presentGroup = this.historyDatas[this.cursor].presentGroup;
    } else {
      this.data = [];
      return this.cursor = -1;
    }
  }

  redo() {
    if (this.cursor + 1 <= this.historyDatas.length - 1) {
      this.cursor++;
      this.data = [...this.historyDatas[this.cursor]];
      return this.presentGroup = this.historyDatas[this.cursor].presentGroup;
    }
  }

  addNoRepeat(preDiv) {
    if (!(preDiv instanceof PreDiv)) {
      throw new Error("添加的元素不是PreDiv的实例");
    }
    if (!this.checkSameSiteRepeat(preDiv)) {
      return this.add(preDiv);
    }
  }

  addNoRepeatAutoDraw(preDiv) {
    if (!(preDiv instanceof PreDiv)) {
      throw new Error("添加的元素不是PreDiv的实例");
    }
    if (!(this.data.find((item) => {
      return preDiv.x === item.x && preDiv.y === item.y && !this.findInGroup(item);
    }))) {
      return this.add(preDiv);
    }
  }

  checkSameSiteRepeat(preDiv) {
    var samePreDivs;
    if (!(preDiv instanceof PreDiv)) {
      throw new Error("添加的元素不是PreDiv的实例");
    }
    samePreDivs = this.data.find((item) => {
      return preDiv.x === item.x && preDiv.y === item.y && preDiv.imgX === item.imgX && preDiv.imgY === item.imgY && preDiv.url === item.url && preDiv.imgW === item.imgW && preDiv.imgH === item.imgH;
    });
    if (samePreDivs) {
      return samePreDivs;
    } else {
      return null;
    }
  }

  getSelectedItems() {
    return this.data.filter((preDiv) => {
      return preDiv.hasBorder;
    });
  }

  delSelectedItems() {
    this.getSelectedItems().forEach((preDiv) => {
      return preDiv.del();
    });
    return this.record();
  }

  translateSelectedItems(deltaX, deltaY) {
    checkType(arguments, ["number", "number"], "gameEditor.DivList.translateSelectedItem()");
    this.getSelectedItems().forEach((preDiv) => {
      preDiv.x += deltaX;
      return preDiv.y += deltaY;
    });
    return this.updateGroup();
  }

  setXYSelectedItems(x, y) {
    checkType(arguments, ["number", "number"], "gameEditor.DivList.translateSelectedItem()");
    this.getSelectedItems().forEach((preDiv) => {
      preDiv.x = x;
      return preDiv.y = y;
    });
    return this.record();
  }

  changeZIndexSelectedItems(deltaZIndex) {
    checkType(arguments, ["number"], "gameEditor.DivList.changeZIndexSelectedItem()");
    this.showZIndex = true;
    this.showZIndexTimer = clearTimeout(this.showZIndexTimer);
    this.showZIndexTimer = setTimeout(() => {
      this.showZIndex = false;
      return m.redraw();
    }, 1000);
    this.getSelectedItems().forEach((preDiv) => {
      if (preDiv.zIndex + deltaZIndex > 0) {
        return preDiv.zIndex += deltaZIndex;
      }
    });
    return this.record();
  }

  resetZIndexSelectedItems(zIndex) {
    checkType(arguments, ["number"], "gameEditor.DivList.resetZIndexSelectedItem()");
    this.getSelectedItems().forEach((preDiv) => {
      return preDiv.zIndex = zIndex;
    });
    return this.record();
  }

  becomeGroup_noUse() {
    var sameGroup, selectedItems;
    selectedItems = this.getSelectedItems();
    sameGroup = this.groups.find((group) => {
      var tmp1, tmp2;
      tmp1 = group.every((item1) => {
        return selectedItems.some((item2) => {
          return item1 === item2;
        });
      });
      tmp2 = selectedItems.every((item1) => {
        return group.some((item2) => {
          return item1 === item2;
        });
      });
      return tmp1 && tmp2;
    });
    if (sameGroup) { //已经有相同的组，不需要再编组
      return;
    }
    this.groups.push(selectedItems);
    return this.record();
  }

  findInGroup_noUse(preDiv) {
    var inGroups;
    if (!(preDiv instanceof PreDiv)) {
      throw new Error("要查找所属组的元素不是PreDiv的实例");
    }
    //查找元素所在的组，一个元素可以同时在多个组里
    inGroups = this.groups.filter((group) => {
      return group.find((item) => {
        return preDiv === item;
      });
    });
    if ((inGroups != null ? inGroups.length : void 0) > 0) {
      inGroups = inGroups.sort((x1, x2) => {
        return x2.length - x1.length;
      });
      return inGroups[this.groupLevel];
    } else {
      return null;
    }
  }

  exitGroup_noUse() {
    this.getSelectedItems().forEach((preDiv) => {
      var group, groupIndex;
      group = this.findInGroup(preDiv);
      groupIndex = this.groups.indexOf(group);
      return this.groups.splice(groupIndex, 1);
    });
    return this.record();
  }

  getInRect(gEData) { //获取被框选元素
    checkType(arguments, ["object"], "DivList.getInRect()");
    return this.data.filter((preDiv) => {
      var ref, ref1, ref2, ref3, ref4, ref5, ref6, ref7;
      if ((((gEData.choiseBox2.x < (ref = preDiv.x) && ref < gEData.choiseBox2.x + gEData.choiseBox2.w)) && ((gEData.choiseBox2.y < (ref1 = preDiv.y) && ref1 < gEData.choiseBox2.y + gEData.choiseBox2.h))) || (((gEData.choiseBox2.x < (ref2 = preDiv.x + preDiv.imgW) && ref2 < gEData.choiseBox2.x + gEData.choiseBox2.w)) && ((gEData.choiseBox2.y < (ref3 = preDiv.y) && ref3 < gEData.choiseBox2.y + gEData.choiseBox2.h))) || (((gEData.choiseBox2.x < (ref4 = preDiv.x) && ref4 < gEData.choiseBox2.x + gEData.choiseBox2.w)) && ((gEData.choiseBox2.y < (ref5 = preDiv.y + preDiv.imgH) && ref5 < gEData.choiseBox2.y + gEData.choiseBox2.h))) || (((gEData.choiseBox2.x < (ref6 = preDiv.x + preDiv.imgW) && ref6 < gEData.choiseBox2.x + gEData.choiseBox2.w)) && ((gEData.choiseBox2.y < (ref7 = preDiv.y + preDiv.imgH) && ref7 < gEData.choiseBox2.y + gEData.choiseBox2.h)))) {
        return true;
      } else {
        return false;
      }
    });
  }

  getInRect(gEData) { //获取被框选元素ai版本
    checkType(arguments, ["object"], "DivList.getInRect()");
    return this.data.filter((preDiv) => {
      var x1, x2, y1, y2;
      x1 = Math.max(gEData.choiseBox2.x, preDiv.x);
      y1 = Math.max(gEData.choiseBox2.y, preDiv.y);
      x2 = Math.min(gEData.choiseBox2.x + gEData.choiseBox2.w, preDiv.x + preDiv.imgW);
      y2 = Math.min(gEData.choiseBox2.y + gEData.choiseBox2.h, preDiv.y + preDiv.imgH);
      return x1 < x2 && y1 < y2;
    });
  }

  selectRectItems() {
    this.getInRect(gEData).forEach((preDiv) => {
      if (this.presentGroup) {
        if (preDiv.linkid === this.presentGroup) {
          return preDiv.select(1);
        } else {
          return preDiv.cancelSelect();
        }
      } else {
        if (!preDiv.linkid) {
          return preDiv.select(1);
        } else {
          return preDiv.cancelSelect();
        }
      }
    });
    return this.getSelectedItems().forEach((preDiv) => {
      var group;
      group = this.findInGroup(preDiv);
      return group != null ? group.forEach((preDiv1) => {
        return preDiv1.select(2);
      }) : void 0;
    });
  }

  copySelectedItems() {
    var idMap;
    idMap = {};
    this.copy = this.getSelectedItems().map((preDiv) => {
      var div;
      div = new PreDiv({
        ...preDiv,
        x: preDiv.x + gEData.getW(),
        y: preDiv.y + gEData.getH(),
        id: uuid(),
        hasBorder: 1,
        divList: this
      });
      return div;
    });
    this.getSelectedItems().forEach((preDiv, index) => {
      idMap[preDiv.id] = this.copy[index].id;
      return preDiv.hasBorder = 0;
    });
    this.copy.forEach((preDiv) => {
      return preDiv.linkid = idMap[preDiv.linkid] || "";
    });
    return this.copy;
  }

  pasteCopyedItems() {
    this.data = [...this.data, ...this.copy];
    return this.record();
  }

  fillRect() {
    var allNum, i, j, preObjs, ref, ref1, tmp, xIndex, xNum, xRest, yIndex, yNum, yRest;
    if (!gEData.choiseBox2.w || !gEData.choiseBox2.h || !gEData.choiseBox2.x || !gEData.choiseBox2.y) {
      return Notice.launch({
        msg: "请设置填充区域"
      });
    }
    this.data.forEach((item) => {
      return item.cancelSelect();
    });
    if (gEData.choiseBox2.w > 0 || gEData.choiseBox2.h > 0) {
      gEData.choiseBox2.x = gEData.getBoxX(gEData.choiseBox2.x);
      gEData.choiseBox2.y = gEData.getBoxY(gEData.choiseBox2.y);
      gEData.choiseBox2.w = gEData.getBoxX(gEData.choiseBox2.w);
      gEData.choiseBox2.h = gEData.getBoxY(gEData.choiseBox2.h);
    }
    preObjs = [];
    xNum = Math.floor(gEData.choiseBox2.w / gEData.choiseBox.w);
    yNum = Math.floor(gEData.choiseBox2.h / gEData.choiseBox.h);
    xRest = gEData.choiseBox2.w % gEData.choiseBox.w;
    yRest = gEData.choiseBox2.h % gEData.choiseBox.h;
    allNum = xNum * yNum + xRest * yRest;
    for (xIndex = i = 0, ref = xNum; (0 <= ref ? i < ref : i > ref); xIndex = 0 <= ref ? ++i : --i) {
      for (yIndex = j = 0, ref1 = yNum; (0 <= ref1 ? j < ref1 : j > ref1); yIndex = 0 <= ref1 ? ++j : --j) {
        tmp = new PreDiv({
          id: Date.now(),
          x: gEData.choiseBox2.x + xIndex * gEData.choiseBox.w,
          y: gEData.choiseBox2.y + yIndex * gEData.choiseBox.h,
          imgX: gEData.choiseBox.x,
          imgY: gEData.choiseBox.y,
          imgW: gEData.choiseBox.w,
          imgH: gEData.choiseBox.h,
          url: gEData.tilesetUrl,
          hasBorder: 2
        });
        this.add(new PreDiv(tmp));
      }
    }
    this.becomeGroup();
    return this.record();
  }

  findChildren(id) {
    var groups;
    checkType(arguments, ["string"], "gameEditor.DivList.findChildren()");
    return groups = this.data.filter((preDiv) => {
      return preDiv.linkid === id;
    });
  }

  findChildrenDeep(id, index = 0, childArr = []) {
    var children;
    checkType(arguments, ["string", "number?", "array?"], "gameEditor.DivList.findChildrenDeep()");
    children = this.findChildren(id);
    childArr.push(...children);
    children.forEach((child) => {
      return this.findChildrenDeep(child.id, index++, childArr);
    });
    if (childArr.length > 0) {
      return childArr;
    } else {
      return null;
    }
  }

  getGroups() {
    return this.data.filter((preDiv) => {
      return preDiv.isGroup;
    });
  }

  updateGroup() { //根据子元素调整组边界
    return this.getGroups().forEach((group) => {
      var children, x, x1, y, y1, z;
      children = this.findChildrenDeep(group.id);
      x = y = x1 = y1 = z = 0;
      children.forEach((child, index) => {
        if (index === 0) {
          x = child.x;
          y = child.y;
          x1 = child.x + child.imgW;
          y1 = child.y + child.imgH;
          z = child.zIndex;
        }
        x = child.x < x ? child.x : x;
        y = child.y < y ? child.y : y;
        x1 = child.x + child.imgW > x1 ? child.x + child.imgW : x1;
        y1 = child.y + child.imgH > y1 ? child.y + child.imgH : y1;
        return z = child.zIndex > z ? child.zIndex : z;
      });
      group.x = x;
      group.y = y;
      group.imgW = x1 - x;
      group.imgH = y1 - y;
      return group.zIndex = z + 1;
    });
  }

  becomeGroup() {
    var group, groupId, selectedItems;
    selectedItems = this.getSelectedItems();
    selectedItems = selectedItems.filter((preDiv) => {
      if (this.presentGroup) {
        return preDiv.linkid === this.presentGroup;
      } else {
        return !preDiv.linkid;
      }
    });
    //beforeLinkid = selectedItems[0].linkid
    groupId = uuid();
    selectedItems.forEach((preDiv, index) => {
      return preDiv.linkid = groupId;
    });
    group = new PreDiv({
      id: groupId,
      linkid: this.presentGroup || "",
      isGroup: true,
      x: 0,
      y: 0,
      imgX: 0,
      imgY: 0,
      zIndex: 99,
      imgW: 0,
      imgH: 0,
      url: "",
      hasBorder: 1
    });
    group.changeId(groupId);
    this.add(group, true);
    this.updateGroup();
    return this.record();
  }

  findInGroup(preDiv) {
    var fn, output;
    if (!(preDiv instanceof PreDiv)) {
      throw new Error("要查找所属组的元素不是PreDiv的实例");
    }
    output = [];
    fn = (preDiv) => {
      return this.data.forEach((item) => {
        if (item.linkid === preDiv.id) { //and item.linkid isnt @presentGroup
          fn(item);
          return output.push(item);
        }
      });
    };
    fn(preDiv);
    if (output.length > 0) {
      return output;
    } else {
      return null;
    }
  }

  setPresentGroup(groupId) {
    checkType(arguments, ["string"], "gameEditor.DivList.setPresentGroup()");
    return this.presentGroup = groupId;
  }

  cancelSelectAll() {
    return this.data.forEach((preDiv) => {
      return preDiv.cancelSelect();
    });
  }

  isInGroup(preDiv) {
    var ref;
    if (this.presentGroup) {
      if ((ref = gEData.divList.findChildrenDeep(gEData.divList.presentGroup)) != null ? ref.find((child) => {
        return child.id === preDiv.id;
      }) : void 0) {
        return true;
      } else {
        return false;
      }
    } else {
      return true;
    }
  }

  exitGroup() {
    return this.getSelectedItems().forEach((preDiv) => {
      if (preDiv.isGroup) {
        this.data.forEach((dataPreDiv) => {
          if (dataPreDiv.linkid === preDiv.id) { //修改子元素指向
            if (preDiv.linkid) {
              return dataPreDiv.linkid = preDiv.linkid;
            } else {
              return dataPreDiv.linkid = "";
            }
          }
        });
        return preDiv.del(); //删除组
      }
    });
  }

  save() {}

  load() {}

  async export() {
    var aDom, blob, canvas, ctx, divListOrder, i, len, preDiv;
    canvas = document.createElement("canvas");
    canvas.width = gEData.canvasWidth;
    canvas.height = gEData.canvasHeight;
    ctx = canvas.getContext("2d");
    divListOrder = this.data.sort((x1, x2) => {
      return Number(x1.dom.style.zIndex) - Number(x2.dom.style.zIndex);
    });
    for (i = 0, len = divListOrder.length; i < len; i++) {
      preDiv = divListOrder[i];
      await (async(preDiv) => {
        var imgDom;
        imgDom = (await new Promise((res, rej) => {
          imgDom = new Image();
          imgDom.src = preDiv.url;
          return imgDom.onload = () => {
            return res(imgDom);
          };
        }));
        return ctx.drawImage(imgDom, preDiv.imgX, preDiv.imgY, preDiv.imgW, preDiv.imgH, preDiv.x, preDiv.y, preDiv.imgW, preDiv.imgH);
      })(preDiv);
    }
    
    //data = canvas.toDataURL "image/png"
    blob = (await new Promise((res, rej) => {
      return canvas.toBlob((blob) => {
        return res(blob);
      });
    }));
    aDom = document.createElement("a");
    aDom.download = `map_${Date.now()}.png`;
    aDom.href = window.URL.createObjectURL(blob);
    document.body.appendChild(aDom);
    aDom.click();
    return aDom.remove();
  }

};
